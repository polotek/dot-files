<?php
require_once('../lib/includes/application_top.php');

include(COMMON_DIR.'/includes/templates_header.inc.php');

include(MODULES_DIR. '/column_left_nextgov.php');

function getAdConfig($db, $clauses=''){
    $sql = 'select * from "ad_manager"';

    if(!empty($clauses)) $sql .= ' where '.$clauses;

    $ads = $db->query($sql, PDO::FETCH_ASSOC);

    return $ads;
}

function updateAdConfig($db, $ad_selector, $storyid, $page, $old_ad_type){
    global $pageArray;
    global $secNames;
    global $adTypes;

    $sql = 'UPDATE "ad_manager" SET "ad_type" = \''.$ad_selector.'\', "storyid" = \''.$storyid.'\' WHERE "page_type" = \''.$page.'\' AND "storyid" = \''.$storyid.'\'';
		
    $old_ad_type = $adTypes[$old_ad_type];
    $ad_selector = $adTypes[$ad_selector];

    if($updateresult = $db->query($sql)){
        $return_string = "Successfully changed ads on ".$secNames[$page].":<br /> from ".$old_ad_type." => ".$ad_selector;
        if($storyid != "") $return_string .= " for StoryID ".$storyid;
    }
    else{
        $return_string = "There was an error changing the ads on ".$secNames[$page].":<br />  from ".$old_ad_type." => ".$ad_selector;
        if($storyid != "") $return_string .= " for StoryID ".$storyid;
    }
    
    return $return_string;
}

function insertAdConfig($db, $ad_selector, $storyid, $page, $old_ad_type){
    global $pageArray;
    global $secNames;
    global $adTypes;

    $sql = 'INSERT INTO "ad_manager" ("storyid", "page_type", "ad_type") VALUES (\''.$storyid.'\', \''.$page.'\', \''.$ad_selector.'\')';


    $old_ad_type = $adTypes[$old_ad_type];
    $ad_selector = $adTypes[$ad_selector];

    if($insertresult = $db->query($sql)){
        $return_string = "Successfully inserted ads on ".$secNames[$page].":<br />".$old_ad_type." => ".$ad_selector;
        if(!empty($storyid) && $storyid !== "0") $return_string .= " for StoryID ".$storyid;
    }else{
        $return_string = "There was an error inserting ads on ".$secNames[$page];
        if(!empty($storyid) && $storyid !== "0") $return_string .= " for StoryID ".$storyid;
    }

    return $return_string;
}

$adconfig = getAdConfig($db);

$secNames = array(
    'default' => 'Default',
    'articles'=>'Articles',
    'basics' => 'The Basics',
    'forums' => 'Forums',
    'homepage' => 'Home Page',
    'search_results' => 'Search Results',
    'techinsider' => 'Tech Insider'
    );

$adTypes = array(
    'default'=>'Default Settings',
    'tower' => ' Tower (300x600, Default)',
    'towerblock' => 'Tower + Block (300x600 + 300x250)',
    '2boxes' => 'Two Blocks (2x 300x250)',
    '3boxes' => 'Three Blocks (3x 300x250)',
    );

$page = safeget('page', 'default');
$storyid = safeget('storyid', '0');
$ad_selector = safeget('ad_selector', $pageArray[$page]);

$old_ad_type = 'none';
foreach($adconfig as $aditem){

    if($page == $aditem['page_type'] && $page != 'basics') $old_ad_type = $aditem['ad_type'];

    if($page == 'basics'){
        if($aditem['storyid'] == $storyid){
            $old_ad_type = $aditem["ad_type"];

            if($_SERVER['REQUEST_METHOD'] == 'GET') $ad_selector = $aditem['ad_type'];
        }
    }
}

if($_SERVER['REQUEST_METHOD'] == "POST"){

    $insertnew = true;

    var_dump($adconfig);
    foreach($adconfig as $aditem){
        if($aditem['page_type'] == $page){
            if($page == 'basics' && $storyid != $aditem['storyid']){
                continue;
            } 

            $insertnew = false;
        }
    }

    if($insertnew){
        $return_string = insertAdConfig($db, $ad_selector, $storyid, $page, $old_ad_type);
    } else {
        $return_string = updateAdConfig($db, $ad_selector, $storyid, $page, $old_ad_type);
    }

}

?>

<div class="column_middle">

    <script language="JavaScript" type="text/javascript">
	function jumpMenu(){
            var page = document.getElementById('page');
            page = page.options[page.selectedIndex].value;
            var sid = document.getElementById('storyid');
            if(sid) {
                sid = sid.options[sid.selectedIndex].value;
            } else {
                sid = '0';
            }

	    url = '/atd_admin_zzzz/index.php?page='+encodeURIComponent(page)+'&storyid='+encodeURIComponent(sid);
            window.location=url;
	}
    </script>
<?php 

if(!empty($return_string)) echo '<div style="padding:5px; background-color:#669900;"><span id="sub_text">'.$return_string."</span></div><br /><br />";

?>
 <form name="ad_controller" action="<?php echo $_SERVER['PHP_SELF']?>" method="POST">
	<select name="page" id="page" onChange="jumpMenu();">
		<?php
		foreach($secNames AS $key => $value){
                    if($page == $key){
                        $selected = ' selected="selected"';
                    } else {
                        $selected = '';
                    }
                    echo '<option value="'.$key.'"'.$selected.'>'.$value.'</option>';
		}
		?>
	</select><br /><br />
<?php	


        if($page == "basics"){
			$basics_query = '
				SELECT s."StoryID", sv."Headline"
				FROM "Story" s, "StoryVersion" sv
	        		     where 
                                          s."StoryID" = sv."StoryID"
                                          and  s."LiveVersionID" = sv."StoryVersionID"
                                          and sv."PublishedYN" = true
				          and s."SectionID" = \'the_basics\'';
									
				//echo $basics_query;
                        $qresult = $db->query($basics_query, PDO::FETCH_ASSOC);
                
                        echo '<select name="storyid" id="storyid" onChange="jumpMenu();">';

			echo '<option value="0">Basics Default</option>';

			foreach ($qresult as $key => $result) {
                            $selected = ($storyid == $result['StoryID']) ? ' selected' : '';
                            echo '<option value="'.$result['StoryID'].'"'.$selected.'>'.$result['Headline'].'</option>';
                        }

			echo '</select><br /><br />';
        }

?>
	<select name="ad_selector">
    <?php 
              if($page != 'default'){ 
?>

                <option value="default"<?php if($ad_selector == "default") echo " selected";?>>Default Settings - Currently <?php echo $adTypes[$pageArray['default']]; ?></option>

<?php
              }
?>
                <option value="tower"<?php if($ad_selector == "tower") echo " selected";?>><?php echo $adTypes['tower']; ?></option>
		<option value="towerblock"<?php if($ad_selector == "towerblock") echo " selected";?>><?php echo $adTypes['towerblock']; ?></option>
		<option value="2boxes"<?php if($ad_selector == "2boxes") echo " selected";?>><?php echo $adTypes['2boxes']; ?></option>
		<option value="3boxes"<?php if($ad_selector == "3boxes") echo " selected";?>><?php echo $adTypes['3boxes']; ?></option>
	</select>
	<br /><br />
	<input type="submit" value="Submit">
	</form>

</div>

<?php

include(COMMON_DIR.'/includes/templates_right_column.inc.php');

include(COMMON_DIR.'/includes/templates_footer.inc.php');	

?>
